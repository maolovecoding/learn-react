# React fiber



## 屏幕刷新率

- 目前大多数设备的屏幕刷新率是60次每秒
- 浏览器渲染动画或者页面的每一帧的速率也需要根设备屏幕的刷新率保持一致
- 页面是一帧一帧绘制出来的，当每秒的帧数（FPS）达到60，页面是流畅的，小于这个值，用户会感觉到卡顿
- 每一帧的预算时间大概是16.6ms
- 1s 60帧，所以每帧时间大概16.6ms，我们书写代码时力求不让每一帧工作量超过16.6

## 每帧浏览器都做了什么

1. 阻塞输入事件（输入事件，触摸事件，鼠标滚动事件），非阻塞输入事件（点击，键盘事件）。因为和用户交互，优先级最高
2. 定时器，js脚本，微任务
3. 开始帧（每一帧的事件，如窗口resize事件，滚动，媒体查询事件）
4. requestAnimateFrame
5. layout布局，计算样式，更新布局
6. 绘制paint，记录，合成图层等
7. 空闲阶段（idle peroid）requestIdleCallback



## fiber执行阶段

- 每次渲染有两个阶段，Reconciliation（协调render阶段）和commit（提交阶段）
  - 协调节点：可以认识是Diff节点，这个阶段可以被中断，这个阶段会找出所有阶段变更，例如节点的新增，删除，属性变更等等，这些变更react称之为副作用（Effect）
  - 提交节点：将上一个阶段计算出来的需要处理的副作用（effects）一次性执行了，这个阶段必须同步执行，不能打断

### render阶段

- 从顶点开始遍历
- 如果有第一个二次，先遍历第一个儿子
- 如果没有第一个儿子，标志着此节点遍历完成
- 如果有滴滴遍历弟弟
- 如果没有下一个弟弟，返回父节点标识完成父节点的遍历，如果有叔叔遍历叔叔
- 没有父节点 遍历结束

流程上：

- 先儿子，后弟弟，再叔叔，“辈分”越小越优先
- 什么时候一个节点遍历完成？
  - 没有子节点，或者所有子节点都遍历完成了
- 没“爹”了就表示全部遍历完成了



















